import argparse
import os
import re
from idlelib.iomenu import encoding


class SmartSearch:
    def __init__(self, dir_path):
        self.dir_path = dir_path
        self.files = self.read_file()

    def read_file(self):
        files = {}
        # Listar ficheros de directorio
        for archivo in os.listdir(self.dir_path):
            file_path = os.path.join(self.dir_path, archivo)
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    files[archivo] = f.read()
            except Exception as e:
                print(f"Error al leer el archivo {file_path}: {e}")
        return files

    def regex_search(self, regex):
        # Busca información utilizando expresiones regulares
        coincidencias = {}
        # Recorremos el contenido de todos los ficheros del directorio
        for file, text in self.files.items():
            respuesta = ""
            while respuesta not in ('y', 'n', 'yes', 'no'):
                respuesta = input(f"El fichero {file} tiene una longitud de {len(text)} caracteres. Procesar?"
                                  f"('yes','no','y','n'):\n").lower()
                if respuesta in ('n', 'no'):
                    continue
                matches = re.findall(regex, text, re.IGNORECASE)
                if not matches:
                    coincidencias[file] = matches
        return coincidencias

if __name__ == '__main__':
    # Configuramos los argumentos del programa
    parser = argparse.ArgumentParser(description='Realiza búsquedas en los ficheros de un directorio')
    parser.add_argument('dir_path',type=str,
                        help='Directorio que se quiere realizar')
    parser.add_argument('-r', '--regex',type=str,
                        help='Expresión regular para realizar busqueda')

    # Parsemaos los argumentos
    args = parser.parse_args()
    if args.regex:
        searcher = SmartSearch(args.dir_path)
        resutaldos_busqueda = searcher.regex_search(args.regex)
        print()
        for file, result in resutaldos_busqueda.items():
            print(file)
            for r in result:
                print(f"\t{r}")
